# Code Review & Testing - Mandatory Workflow

## The Law

**Every generated code file MUST follow this workflow before implementation:**

1. âœ… Code generated
2. âœ… Tests written
3. âœ… Tests MUST PASS
4. âœ… You review the code
5. âœ… You approve or deny
6. âœ… If approved: implemented + docs updated
7. âœ… If denied: feedback saved + model learns

**NO SHORTCUTS. NO EXCEPTIONS.**

---

## The Workflow (Step by Step)

### Step 1: Code Generated by Agent

```
You:   "Write a Swift function that..."
Agent: [Generates code file + test file]
```

### Step 2: Tests Run Automatically

```
System: Running tests...
        Executing: test_my_function.py
        Result: âœ… PASSED (or âŒ FAILED)
```

### Step 3: You Review

If tests PASSED:
```
Dialog appears:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CODE REVIEW REQUIRED            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Description: Swift JSON decoder â”‚
â”‚ File: JSONDecoder.swift         â”‚
â”‚ Tests: âœ… PASSED                â”‚
â”‚                                 â”‚
â”‚ APPROVE  [  ]  DENY  [  ]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

If tests FAILED:
```
You see:
âŒ TESTS FAILED
  Error: DecodingError not handled
  
Do you want to review anyway? (y/n)
```

### Step 4: Approve or Deny

**If APPROVE âœ…**:
- Code is marked as implemented
- README is automatically updated
- Your approval is recorded in memory
- Model learns: "This code style is good"

**If DENY âŒ**:
- Code is NOT implemented
- You explain why in the dialog
- Your feedback is saved
- Model learns: "This code needs improvement"

### Step 5: Auto-Updates

When approved:
```
âœ… README updated
âœ… Code marked implemented
âœ… Memory recorded
âœ… Training data saved
```

---

## Quick Commands

### Run Full Workflow
```bash
# This happens automatically when agent generates code
python3 code_review_enforcer.py review <id> "Description" code_file.py test_file.py
```

### View Review History
```bash
python3 code_review_enforcer.py report
```

### Manual Review of Existing Code
```bash
python3 code_review_enforcer.py review req_123 "My function" myfile.py test_myfile.py
```

---

## What Gets Tracked

### In code_review_history.jsonl
```json
{
  "request_id": "req_123",
  "timestamp": "2026-02-01T10:30:00",
  "code_description": "Swift JSON decoder",
  "code_file": "JSONDecoder.swift",
  "test_file": "test_JSONDecoder.py",
  "user_decision": "approved",
  "user_feedback": "Great error handling",
  "status": "implemented"
}
```

### In agent_memory.json
```json
{
  "review_history": {
    "req_123": {
      "approved": true,
      "description": "Swift JSON decoder",
      "timestamp": "2026-02-01T10:30:00"
    }
  }
}
```

### Auto-Updated Files
- README.md (code section added)
- agent_memory.json (review recorded)
- code_review_history.jsonl (full history)
- training_data.jsonl (model learns from approval)

---

## Test Requirements

### Every Generated Code Must Have Tests

```python
# âœ… GOOD - Has comprehensive tests
def test_decode_json():
    # Test valid JSON
    assert decode('{"key": "value"}') == {"key": "value"}
    # Test error handling
    assert decode('{invalid}') raises JSONDecodeError
    # Test edge cases
    assert decode('') raises EmptyError

# âŒ BAD - No tests
def my_function():
    return "something"
```

### Test Must Pass

```
âŒ FAILS: Agent generates code, tests fail
         System: "Tests failed - fix before review"
         
âœ… PASSES: Agent generates code, tests pass
          System: "Ready for review"
```

### Tests Are Part of the Record

When you view a code review:
```
Tests: âœ… PASSED
  - test_decode_valid.json: PASS
  - test_decode_invalid.json: PASS  
  - test_decode_empty.json: PASS
```

---

## Examples

### Example 1: Successful Approval

```
Command:
python3 code_review_enforcer.py review req_456 "URL session timeout handling" \
  URLSessionTimeout.swift test_URLSessionTimeout.py

Output:
ğŸ§ª Running tests: test_URLSessionTimeout.py
âœ… ALL TESTS PASSED

ğŸ“‹ CODE REVIEW ENFORCEMENT WORKFLOW
[1/4] Testing generated code... âœ…
[2/4] Requesting approval...

Dialog: Do you approve this code?
You: âœ… APPROVE "Perfect timeout handling"

[3/4] Updating documentation... âœ…
[4/4] Implementation status: âœ… COMPLETE

âœ… CODE APPROVED & IMPLEMENTED
   File: URLSessionTimeout.swift
   Tests: PASSED âœ…
   Docs: UPDATED âœ…
```

### Example 2: Denial with Feedback

```
Command:
python3 code_review_enforcer.py review req_457 "Error handler" ErrorHandler.swift test_ErrorHandler.py

Output:
ğŸ§ª Running tests: test_ErrorHandler.py
âœ… ALL TESTS PASSED

Dialog: Do you approve this code?
You: âŒ DENY "Missing case for SSL errors"

[3/4] Review result: âŒ DENIED
   Feedback: "Missing case for SSL errors"

[4/4] Next steps:
   1. Review the feedback above
   2. Modify code to address concerns
   3. Run tests again
   4. Request review again

Model learns: This style needs SSL error handling
```

### Example 3: Tests Fail

```
Output:
ğŸ§ª Running tests: test_MyFile.py
âŒ TESTS FAILED
  AssertionError: test_edge_case failed

âš ï¸ TESTS FAILED - Review anyway?
You: n

âŒ Code review skipped - tests must pass

(Agent fixes code, adds better tests, tries again)
```

---

## Integration Points

### With Agent (run_agent.py)

When agent generates code:
```python
# In run_agent.py
code_file = agent.generate_code(prompt)
test_file = agent.generate_tests(code_file)

# Automatically trigger review
enforcer.execute_enforcement_workflow(
    request_id=request_id,
    code_description=description,
    code_file=code_file,
    test_file=test_file
)
```

### With Training (model_trainer.py)

When you approve/deny:
```
Code Review â†’ agent_memory.json â†’ model_trainer.py

Model learns:
- Approvals: "This code style is good"
- Denials: "This code needs improvement"
```

### With macOS Approval (macos_approver.py)

```
Review enforcer calls macos_approver
Approval dialog appears
Your decision recorded
Model learns
```

---

## Workflow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent generates code + tests                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Run tests             â”‚
        â”‚ test_file.py          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Tests pass?          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚       â”‚
            YES â”‚       â”‚ NO
                â”‚       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Code      â”‚  â”‚ Ask review?   â”‚
        â”‚ Review    â”‚  â”‚ anyway?       â”‚
        â”‚ Dialog    â”‚  â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
        â””â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”˜    â”‚           â”‚
            â”‚   â”‚       YES         NO
         YES â”‚   â”‚ NO     â”‚          â”‚
            â”‚   â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”‚
      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”˜â”‚    â”‚ Feedback  â”‚   â”‚
      â”‚         â”‚    â”‚ recorded  â”‚   â”‚
      â”‚      â”Œâ”€â”€â–¼â”€â”€â” â”‚ DENIED    â”‚   â”‚
      â”‚      â”‚Deny â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
      â”‚      â””â”€â”€â”€â”€â”€â”˜                 â”‚
      â”‚                              â”‚
  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚ âœ… APPROVED                  â”‚   â”‚
  â”‚ - Code implemented           â”‚   â”‚
  â”‚ - README updated             â”‚   â”‚
  â”‚ - Memory recorded            â”‚   â”‚
  â”‚ - Model learns: GOOD         â”‚   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜   â”‚
                               â”‚     â”‚
                               â”‚     â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â–´â”€â”€â”€â”€â”€â”€â”
                        â”‚ âŒ DENIED   â”‚
                        â”‚ Fix & retry â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Configuration

### Requirements File: requirements_review.txt

```
# Code Review dependencies
pytest>=7.0
pytest-cov>=4.0
```

### Settings in run_agent.py

```python
# Code Review Settings
ENFORCE_REVIEW = True  # Always enforce workflow
REQUIRE_TESTS = True   # Every code must have tests
TEST_PASS_REQUIRED = True  # Tests must pass before review
AUTO_UPDATE_DOCS = True  # Update README on approval
```

---

## Troubleshooting

### "Tests won't run"

```bash
# Check test file exists
ls -la test_myfile.py

# Run manually
python3 test_myfile.py

# Check for syntax errors
python3 -m py_compile test_myfile.py
```

### "Dialog didn't appear"

```bash
# Make sure Ollama model supports dialogs
python3 -c "from macos_approver import process_approval_request"

# Test manually
python3 test_macos_approval.py
```

### "Code was approved but not implemented"

```bash
# Check review history
cat code_review_history.jsonl | tail -5

# Check README updates
git diff README.md
```

---

## Summary

âœ… **Generate**: Agent creates code + tests
âœ… **Test**: Tests run automatically
âœ… **Review**: You approve/deny via dialog
âœ… **Document**: README auto-updated if approved
âœ… **Learn**: Model learns from your decisions
âœ… **Track**: Everything recorded in history

**This is mandatory. No shortcuts.**

Files:
- [code_review_enforcer.py](code_review_enforcer.py) - Enforcement system
- code_review_history.jsonl - Review history
- agent_memory.json - Memory of approvals
